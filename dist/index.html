<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
	<style>
        body { margin: 0; overflow: hidden; }
        #switchButton {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        #fade {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 1;
            pointer-events: none;
            transition: opacity 1s ease-in-out;
            z-index: 100;
        }
    </style>
  </head>
  <body>
    <div id="fade"></div>
    <button id="switchButton">In 360</button>
    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false"
      id="scene">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="./Scenes/Rocket.glb"></a-asset-item>
      </a-assets>
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-entity mindar-image-target="targetIndex: 0" id="target">
        <a-gltf-model id="rocket" rotation="90 0 0" position="0 0 0" scale="1 1 1" src="#avatarModel"> </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      let clock = new THREE.Clock();
      let mixer = null;
      let rocketObject = null;

      document.addEventListener("DOMContentLoaded", () => {
        const target = document.querySelector("#target");
        const rocket = document.querySelector("#rocket");

        rocket.addEventListener("model-loaded", () => {
          console.log("The model is loaded!");
          rocketObject = rocket.getObject3D("mesh");
          mixer = new THREE.AnimationMixer(rocketObject);
          let clips = rocketObject.animations;

          if (clips.length > 0) {
            let action = mixer.clipAction(clips[0]);
            action.play();
            console.log("Play Animation: ", clips[0].name);
          } else {
            console.log("Animation not found");
          }

          // Как только страница загружена, начинаем плавное появление сцены
          setTimeout(() => {
              fade.style.opacity = 0; // Прозрачность исчезает
              //sceneContainer.style.display = 'block'; // Показываем контейнер сцены
              setTimeout(() => {
                  sceneContainer.style.opacity = 1; // Сцена становится видимой
              }, 100); // Плавное появление через короткую задержку
          }, 1000);  // Немного подождать, чтобы затемнение исчезло
        });

        target.addEventListener("targetFound", () => {
          console.log("The target has been found! Starting the animation.");
          if (mixer) {
            let clips = rocketObject.animations;
            if (clips.length > 0) {
              let action = mixer.clipAction(clips[0]);
              action.play();
            }
          }
        });

        target.addEventListener("targetLost", () => {
          console.log("The target is lost! Stop the animation.");
          if (mixer) {
            mixer.stopAllAction();  // Останавливаем все действия
          }
        });
      });

      function animate() {
        requestAnimationFrame(animate);

        // Используем систему рендеринга A-Frame для рендеринга сцены
        const scene = document.querySelector('a-scene');
        if (scene && scene.hasLoaded) {
          scene.render();
        }

        if (mixer) {
          let delta = clock.getDelta();
          mixer.update(delta);
        }
      }

      animate();

      let fade = document.getElementById('fade');
        let switchButton = document.getElementById("switchButton");

        switchButton.addEventListener("click", () => {
            // Плавное затемнение
            fade.style.opacity = 1;

            setTimeout(() => {
                // Переход на страницу 360
                window.location.href = '360scene.html';
            }, 1000);  // Задержка, чтобы затемнение завершилось
        });
    </script>
  </body>
</html>